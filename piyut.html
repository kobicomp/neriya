<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ××§×•××•×ª ×™×©×™×‘×”</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
            padding: 20px;
        }

        .sidebar {
            width: 350px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            height: fit-content;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .hall-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: auto;
            position: relative;
        }

        .search-section {
            margin-bottom: 25px;
        }

        .search-section h3 {
            margin-bottom: 15px;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .search-group {
            margin-bottom: 15px;
        }

        .search-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .search-group input,
        .search-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-group input:focus,
        .search-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .stats {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats h4 {
            margin-bottom: 10px;
            color: #1f2937;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .stat-label {
            color: #6b7280;
        }

        .stat-value {
            font-weight: 600;
            color: #1f2937;
        }

        .occupied { color: #dc2626; }
        .available { color: #059669; }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .hall-map {
            direction: ltr;
            position: relative;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            min-height: 600px;
            overflow: auto;
        }

        .bimah {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 80px;
            background: #8b5cf6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .seating-area {
            margin-top: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .row-label {
            width: 35px;
            height: 30px;
            background: #4f46e5;
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            margin-left: 15px;
        }

        .seat {
            width: 35px;
            height: 35px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            background: white;
            position: relative;
        }

        .seat:hover {
            transform: scale(1.1);
            z-index: 5;
        }

        .seat.available {
            background: #dcfce7;
            border-color: #16a34a;
            color: #15803d;
        }

        .seat.occupied {
            background: #fecaca;
            border-color: #dc2626;
            color: #b91c1c;
        }

        .seat.selected {
            background: #dbeafe;
            border-color: #2563eb;
            color: #1d4ed8;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
        }

        .seat-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 10;
            margin-bottom: 5px;
        }

        .seat:hover .seat-tooltip {
            opacity: 1;
        }

        .seat-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1f2937;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #1f2937;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-size: 0.85rem;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #1f2937;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #d1d5db;
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .hall-map {
                padding: 15px;
            }
            
            .seat {
                width: 30px;
                height: 30px;
                font-size: 0.7rem;
            }
            
            .modal-content {
                padding: 20px;
            }
        }

        .info-box {
            margin-top: 15px;
            padding: 10px;
            background: #e0f2fe;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .gender-indicator {
            font-size: 0.7rem;
            margin-right: 2px;
        }

        .male { color: #2563eb; }
        .female { color: #db2777; }

        .debug-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª‘ ××¢×¨×›×ª × ×™×”×•×œ ××§×•××•×ª ×™×©×™×‘×”</h1>
            <p>× ×™×”×•×œ ×•×”×§×¦××ª ××§×•××•×ª ×‘××•×œ×</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="search-section">
                    <h3>ğŸ” ×—×™×¤×•×© ×•××™×•×Ÿ</h3>
                    
                    <div class="search-group">
                        <label>×—×™×¤×•×© ×œ×¤×™ ×©×</label>
                        <input type="text" id="searchName" placeholder="×”×›× ×¡ ×©× ×œ×—×™×¤×•×©...">
                    </div>
                    
                    <div class="search-group">
                        <label>×—×™×¤×•×© ×œ×¤×™ ××§×•×</label>
                        <input type="text" id="searchSeat" placeholder="×œ××©×œ: 5-7">
                    </div>
                    
                    <div class="search-group">
                        <label>××¦×‘ ××§×•×</label>
                        <select id="filterStatus">
                            <option value="">×”×›×œ</option>
                            <option value="available">×¤× ×•×™</option>
                            <option value="occupied">×ª×¤×•×¡</option>
                        </select>
                    </div>

                    <div class="search-group">
                        <label>××’×“×¨</label>
                        <select id="filterGender">
                            <option value="">×”×›×œ</option>
                            <option value="×–×›×¨">×–×›×¨</option>
                            <option value="× ×§×‘×”">× ×§×‘×”</option>
                        </select>
                    </div>
                </div>

                <div class="stats">
                    <h4>ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</h4>
                    <div class="stat-item">
                        <span class="stat-label">×¡×”"×› ××§×•××•×ª:</span>
                        <span class="stat-value" id="totalSeats">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">××§×•××•×ª ×ª×¤×•×¡×™×:</span>
                        <span class="stat-value occupied" id="occupiedSeats">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">××§×•××•×ª ×¤× ×•×™×™×:</span>
                        <span class="stat-value available" id="availableSeats">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">×–×›×¨×™×:</span>
                        <span class="stat-value male" id="maleCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">× ×§×‘×•×ª:</span>
                        <span class="stat-value female" id="femaleCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">×ª×¤×•×¡×”:</span>
                        <span class="stat-value" id="occupancyRate">0%</span>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="loadFromExcel()">ğŸ“ ×˜×¢×Ÿ ××”×§×•×‘×¥</button>
                    <button class="btn btn-primary" onclick="saveToLocal()">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
                    <button class="btn btn-secondary" onclick="resetToOriginal()">ğŸ”„ ×—×–×•×¨ ×œ××§×•×¨</button>
                    <button class="btn btn-secondary" onclick="toggleDebug()">ğŸ”§ ×“×™×‘×•×’</button>
                    <button class="btn btn-danger" onclick="clearAllSeats()">ğŸ—‘ï¸ × ×§×” ×”×›×œ</button>
                </div>

                <div class="info-box">
                    <strong>ğŸ’¡ ××‘× ×” ×”×§×•×‘×¥:</strong><br>
                    â€¢ B: ×©× ××©×¤×—×”<br>
                    â€¢ D: ×©× ×¤×¨×˜×™ 1 | E: ××’×“×¨ | F: ××§×•×<br>
                    â€¢ G: ×©× ×¤×¨×˜×™ 2 | H: ××’×“×¨ | I: ××§×•×<br>
                    â€¢ ×¤×•×¨××˜: "×©×•×¨×” X ×›×™×¡× Y"
                </div>

                <div id="debugInfo" class="debug-info" style="display: none;">
                    <strong>ğŸ”§ ××™×“×¢ ×“×™×‘×•×’:</strong>
                    <div id="debugContent"></div>
                </div>

                <div id="searchResults"></div>
            </div>

            <div class="hall-container">
                <div class="legend">
                    <h4>××§×¨×</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dcfce7; border-color: #16a34a;"></div>
                        <span>×¤× ×•×™</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fecaca; border-color: #dc2626;"></div>
                        <span>×ª×¤×•×¡</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dbeafe; border-color: #2563eb;"></div>
                        <span>× ×‘×—×¨</span>
                    </div>
                    <div class="legend-item">
                        <span style="color: #2563eb;">â™‚</span>
                        <span>×–×›×¨</span>
                    </div>
                    <div class="legend-item">
                        <span style="color: #db2777;">â™€</span>
                        <span>× ×§×‘×”</span>
                    </div>
                </div>

                <div class="hall-map">
                    <div class="bimah">×‘×™××”</div>
                    <div class="seating-area" id="seatingArea">
                        <!-- ×”××§×•××•×ª ×™×•×•×¦×¨×• ×›××Ÿ ×“×™× ××™×ª -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for seat assignment -->
    <div id="seatModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">×”×§×¦××ª ××§×•×</h3>
            <div class="form-group">
                <label>××¡×¤×¨ ××§×•×</label>
                <input type="text" id="seatNumber" readonly>
            </div>
            <div class="form-group">
                <label>×©× ××œ×</label>
                <input type="text" id="personName" placeholder="×”×›× ×¡ ×©× ××œ×">
            </div>
            <div class="form-group">
                <label>××’×“×¨</label>
                <select id="personGender">
                    <option value="">×‘×—×¨ ××’×“×¨</option>
                    <option value="×–×›×¨">×–×›×¨</option>
                    <option value="× ×§×‘×”">× ×§×‘×”</option>
                </select>
            </div>
            <div class="form-group">
                <label>×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)</label>
                <input type="text" id="personNotes" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                <button class="btn btn-danger" id="removeBtn" onclick="removePerson()" style="display: none;">×”×¡×¨</button>
                <button class="btn btn-primary" id="assignBtn" onclick="assignSeat()">×”×§×¦×”</button>
            </div>
        </div>
    </div>

    <script>
        // × ×ª×•× ×™ ×”××§×•××•×ª
        let seatsData = {};
        let originalSeatsData = {}; // × ×ª×•× ×™× ××§×•×¨×™×™× ××”××§×¡×œ
        let selectedSeatId = null;

        // ×”×’×“×¨×•×ª ×”××•×œ× - ×©×•×¨×•×ª ×‘××¡×¤×¨×™×
        const hallLayout = {
            rows: [
                { label: '1', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '2', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '3', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '4', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '5', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '6', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '7', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '8', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '9', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '10', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '11', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '12', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] }
            ]
        };

        // ××ª×—×•×œ ×”××¢×¨×›×ª
        window.addEventListener('load', function() {
            createSeatingLayout();
            loadFromExcel(); // ×˜×¢×™× ×” ××•×˜×•××˜×™×ª
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('searchName').addEventListener('input', performSearch);
            document.getElementById('searchSeat').addEventListener('input', performSearch);
            document.getElementById('filterStatus').addEventListener('change', performSearch);
            document.getElementById('filterGender').addEventListener('change', performSearch);
        }

        // ×¤×•× ×§×¦×™×” ×œ×¤×™×¨×•×© "×©×•×¨×” X ×›×™×¡× Y"
        function parseLocation(locationStr) {
            if (!locationStr || typeof locationStr !== 'string') return null;
            
            const match = locationStr.match(/×©×•×¨×”\s*(\d+)\s*×›×™×¡×\s*(\d+)/);
            if (match) {
                return {
                    row: parseInt(match[1]),
                    seat: parseInt(match[2])
                };
            }
            return null;
        }

        // ×©××™×¨×” ××•×˜×•××˜×™×ª ×‘-localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('hallSeatsData', JSON.stringify(seatsData));
                console.log('× ×ª×•× ×™× × ×©××¨×• ××§×•××™×ª');
            } catch (error) {
                console.error('×©×’×™××” ×‘×©××™×¨×” ××§×•××™×ª:', error);
            }
        }

        // ×˜×¢×™× ×” ×-localStorage
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('hallSeatsData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // ××™×–×•×’ ×¢× ×”× ×ª×•× ×™× ×”×§×™×™××™×
                    Object.keys(parsedData).forEach(seatId => {
                        if (seatsData[seatId]) {
                            seatsData[seatId] = { ...seatsData[seatId], ...parsedData[seatId] };
                        }
                    });
                    console.log('× ×ª×•× ×™× × ×˜×¢× ×• ××”×©××™×¨×” ×”××§×•××™×ª');
                    return true;
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘×˜×¢×™× ×” ××§×•××™×ª:', error);
            }
            return false;
        }

        function createSeatingLayout() {
            const seatingArea = document.getElementById('seatingArea');
            seatingArea.innerHTML = '';

            hallLayout.rows.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';

                // ×ª×•×•×™×ª ×”×©×•×¨×”
                const rowLabel = document.createElement('div');
                rowLabel.className = 'row-label';
                rowLabel.textContent = row.label;
                rowDiv.appendChild(rowLabel);

                // ×™×¦×™×¨×ª ×›×¡××•×ª
                row.seats.forEach(seatNum => {
                    const seatId = `${row.label}-${seatNum}`;
                    const seat = document.createElement('div');
                    seat.className = 'seat available';
                    seat.id = seatId;
                    seat.textContent = seatNum;
                    seat.onclick = () => selectSeat(seatId);

                    // tooltip
                    const tooltip = document.createElement('div');
                    tooltip.className = 'seat-tooltip';
                    tooltip.textContent = `××§×•× ${seatId} - ×¤× ×•×™`;
                    seat.appendChild(tooltip);

                    rowDiv.appendChild(seat);

                    // ××ª×—×•×œ × ×ª×•× ×™ ×”××§×•×
                    seatsData[seatId] = {
                        id: seatId,
                        row: row.label,
                        number: seatNum,
                        occupied: false,
                        person: null
                    };
                });

                seatingArea.appendChild(rowDiv);
            });
        }

        function selectSeat(seatId) {
            // ×‘×™×˜×•×œ ×‘×—×™×¨×” ×§×•×“××ª
            if (selectedSeatId) {
                document.getElementById(selectedSeatId).classList.remove('selected');
            }

            selectedSeatId = seatId;
            document.getElementById(seatId).classList.add('selected');
            
            openModal(seatId);
        }

        function openModal(seatId) {
            const seat = seatsData[seatId];
            const modal = document.getElementById('seatModal');
            
            document.getElementById('seatNumber').value = seatId;
            
            if (seat.occupied) {
                // ××§×•× ×ª×¤×•×¡ - ××¦×‘ ×¢×¨×™×›×”
                document.getElementById('modalTitle').textContent = `×¢×¨×™×›×ª ××§×•× ${seatId}`;
                document.getElementById('personName').value = seat.person.name;
                document.getElementById('personGender').value = seat.person.gender || '';
                document.getElementById('personNotes').value = seat.person.notes || '';
                document.getElementById('removeBtn').style.display = 'inline-block';
                document.getElementById('assignBtn').textContent = '×¢×“×›×Ÿ';
            } else {
                // ××§×•× ×¤× ×•×™ - ××¦×‘ ×”×§×¦××” ×—×“×©×”
                document.getElementById('modalTitle').textContent = `×”×§×¦××ª ××§×•× ${seatId}`;
                document.getElementById('personName').value = '';
                document.getElementById('personGender').value = '';
                document.getElementById('personNotes').value = '';
                document.getElementById('removeBtn').style.display = 'none';
                document.getElementById('assignBtn').textContent = '×”×§×¦×”';
            }
            
            modal.style.display = 'block';
            document.getElementById('personName').focus();
        }

        function closeModal() {
            document.getElementById('seatModal').style.display = 'none';
            
            // ×‘×™×˜×•×œ ×‘×—×™×¨×”
            if (selectedSeatId) {
                document.getElementById(selectedSeatId).classList.remove('selected');
                selectedSeatId = null;
            }
        }

        function assignSeat() {
            const seatId = document.getElementById('seatNumber').value;
            const name = document.getElementById('personName').value.trim();
            const gender = document.getElementById('personGender').value;
            
            if (!name) {
                alert('× × ×œ×”×›× ×™×¡ ×©×');
                return;
            }
            
            const notes = document.getElementById('personNotes').value.trim();
            
            // ×¢×“×›×•×Ÿ × ×ª×•× ×™ ×”××§×•×
            seatsData[seatId].occupied = true;
            seatsData[seatId].person = {
                name: name,
                gender: gender,
                notes: notes
            };
            
            updateSeatDisplay(seatId);
            updateStats();
            saveToLocalStorage(); // ×©××™×¨×” ××•×˜×•××˜×™×ª
            closeModal();
        }

        function removePerson() {
            if (!selectedSeatId) return;
            
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¡×™×¨ ××ª ×”××“× ×××§×•× ×–×”?')) {
                seatsData[selectedSeatId].occupied = false;
                seatsData[selectedSeatId].person = null;
                
                updateSeatDisplay(selectedSeatId);
                updateStats();
                saveToLocalStorage(); // ×©××™×¨×” ××•×˜×•××˜×™×ª
                closeModal();
            }
        }

        function updateSeatDisplay(seatId) {
            const seatElement = document.getElementById(seatId);
            const seat = seatsData[seatId];
            const tooltip = seatElement.querySelector('.seat-tooltip');
            
            if (seat.occupied) {
                seatElement.className = 'seat occupied';
                const genderIcon = seat.person.gender === '×–×›×¨' ? 'â™‚' : seat.person.gender === '× ×§×‘×”' ? 'â™€' : '';
                const genderClass = seat.person.gender === '×–×›×¨' ? 'male' : seat.person.gender === '× ×§×‘×”' ? 'female' : '';
                
                // ×”×•×¡×¤×ª ××™×™×§×•×Ÿ ××’×“×¨ ×œ×›×¡×
                seatElement.innerHTML = `
                    <span class="gender-indicator ${genderClass}">${genderIcon}</span>
                    ${seat.number}
                `;
                
                tooltip.textContent = `××§×•× ${seatId} - ${seat.person.name} (${seat.person.gender || '×œ× ×¦×•×™×Ÿ'})`;
            } else {
                seatElement.className = 'seat available';
                seatElement.innerHTML = seat.number;
                tooltip.textContent = `××§×•× ${seatId} - ×¤× ×•×™`;
            }
        }

        function updateStats() {
            const totalSeats = Object.keys(seatsData).length;
            const occupiedSeats = Object.values(seatsData).filter(seat => seat.occupied).length;
            const availableSeats = totalSeats - occupiedSeats;
            const occupancyRate = totalSeats > 0 ? Math.round((occupiedSeats / totalSeats) * 100) : 0;
            
            const maleCount = Object.values(seatsData).filter(seat => 
                seat.occupied && seat.person && seat.person.gender === '×–×›×¨').length;
            const femaleCount = Object.values(seatsData).filter(seat => 
                seat.occupied && seat.person && seat.person.gender === '× ×§×‘×”').length;
            
            document.getElementById('totalSeats').textContent = totalSeats;
            document.getElementById('occupiedSeats').textContent = occupiedSeats;
            document.getElementById('availableSeats').textContent = availableSeats;
            document.getElementById('occupancyRate').textContent = occupancyRate + '%';
            document.getElementById('maleCount').textContent = maleCount;
            document.getElementById('femaleCount').textContent = femaleCount;
        }

        function performSearch() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const searchSeat = document.getElementById('searchSeat').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value;
            const filterGender = document.getElementById('filterGender').value;
            
            const results = Object.values(seatsData).filter(seat => {
                const matchName = !searchName || (seat.person && seat.person.name.toLowerCase().includes(searchName));
                const matchSeat = !searchSeat || seat.id.toLowerCase().includes(searchSeat);
                const matchStatus = !filterStatus || 
                    (filterStatus === 'occupied' && seat.occupied) ||
                    (filterStatus === 'available' && !seat.occupied);
                const matchGender = !filterGender || (seat.person && seat.person.gender === filterGender);
                
                return matchName && matchSeat && matchStatus && matchGender;
            });
            
            displaySearchResults(results);
            highlightSeats(results);
        }

        function displaySearchResults(results) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            let html = '<div style="margin-top: 20px;"><h4>ğŸ” ×ª×•×¦××•×ª ×—×™×¤×•×©:</h4>';
            
            results.forEach(seat => {
                const status = seat.occupied ? '×ª×¤×•×¡' : '×¤× ×•×™';
                const personInfo = seat.person ? ` - ${seat.person.name}` : '';
                const genderInfo = seat.person && seat.person.gender ? ` (${seat.person.gender})` : '';
                const statusClass = seat.occupied ? 'occupied' : 'available';
                
                html += `
                    <div style="padding: 8px; margin: 5px 0; border-radius: 4px; background: white; border: 1px solid #e5e7eb; cursor: pointer;" 
                         onclick="selectSeat('${seat.id}')">
                        <strong>${seat.id}</strong> 
                        <span class="${statusClass}">(${status})</span>
                        ${personInfo}${genderInfo}
                    </div>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function highlightSeats(results) {
            // ××™×¤×•×¡ ×”×“×’×©×•×ª ×§×•×“××•×ª
            Object.keys(seatsData).forEach(seatId => {
                const element = document.getElementById(seatId);
                element.style.boxShadow = '';
                element.style.transform = '';
            });
            
            // ×”×“×’×©×ª ×ª×•×¦××•×ª ×”×—×™×¤×•×©
            results.forEach(seat => {
                const element = document.getElementById(seat.id);
                element.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.5)';
                element.style.transform = 'scale(1.05)';
            });
        }

        async function loadFromExcel() {
            try {
                console.log('×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×§×•×‘×¥...');
                
                const response = await fetch('1.xlsx');
                if (!response.ok) {
                    throw new Error('×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×”×§×•×‘×¥');
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // × ×¡×” ××ª ×”×’×œ×™×•×Ÿ ×”×¨××©×•×Ÿ ×× 'a' ×œ× ×§×™×™×
                const sheetName = workbook.SheetNames.includes('a') ? 'a' : workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                
                // ×§×¨×™××” ×›××¢×¨×š ×’×•×œ××™ (×œ×œ× ×›×•×ª×¨×•×ª)
                const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                console.log('× ×ª×•× ×™× ×’×•×œ××™×™×:', rawData.slice(0, 5));
                
                // ××ª×—×•×œ ×›×œ ×”××§×•××•×ª ×›×¤× ×•×™×™×
                Object.keys(seatsData).forEach(seatId => {
                    seatsData[seatId].occupied = false;
                    seatsData[seatId].person = null;
                });
                
                let processedPeople = 0;
                let debugInfo = [];
                
                // ×¢×™×‘×•×“ ×”× ×ª×•× ×™× ××”×©×•×¨×” ×”×©× ×™×™×” ×•××™×œ×š
                for (let i = 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    if (!row || row.length === 0) continue;
                    
                    debugInfo.push(`×©×•×¨×” ${i+1}: ${JSON.stringify(row.slice(1, 9))}`);
                    
                    // ×¢××•×“×” B - ×©× ××©×¤×—×” (××™× ×“×§×¡ 1)
                    const familyName = row[1] ? String(row[1]).trim() : '';
                    
                    // ××“× ×¨××©×•×Ÿ - ×¢××•×“×•×ª D,E,F (××™× ×“×§×¡ 3,4,5)
                    const firstName1 = row[3];     // ×¢××•×“×” D - ×©× ×¤×¨×˜×™
                    const gender1 = row[4];        // ×¢××•×“×” E - ××’×“×¨
                    const location1 = row[5];      // ×¢××•×“×” F - ××§×•×
                    
                    // ××“× ×©× ×™ - ×¢××•×“×•×ª G,H,I (××™× ×“×§×¡ 6,7,8)
                    const firstName2 = row[6];     // ×¢××•×“×” G - ×©× ×¤×¨×˜×™
                    const gender2 = row[7];        // ×¢××•×“×” H - ××’×“×¨
                    const location2 = row[8];      // ×¢××•×“×” I - ××§×•×
                    
                    // ×¢×™×‘×•×“ ×”××“× ×”×¨××©×•×Ÿ
                    if (firstName1 && location1) {
                        const parsed1 = parseLocation(location1);
                        if (parsed1) {
                            const seatId = `${parsed1.row}-${parsed1.seat}`;
                            if (seatsData[seatId]) {
                                // ×©× ××œ× = ×©× ×¤×¨×˜×™ + ×©× ××©×¤×—×”
                                const fullName1 = familyName ? 
                                    `${String(firstName1).trim()} ${familyName}` : 
                                    String(firstName1).trim();
                                
                                seatsData[seatId].occupied = true;
                                seatsData[seatId].person = {
                                    name: fullName1,
                                    gender: String(gender1 || '').trim(),
                                    notes: '××§×•×‘×¥ ×”××§×¡×œ'
                                };
                                processedPeople++;
                                debugInfo.push(`âœ“ ××“× 1: ${fullName1} ×‘××§×•× ${seatId}`);
                            } else {
                                debugInfo.push(`âœ— ××§×•× ×œ× ×§×™×™×: ${seatId} ×¢×‘×•×¨ ${firstName1}`);
                            }
                        } else {
                            debugInfo.push(`âœ— ×œ× × ×™×ª×Ÿ ×œ×¤×¢× ×— ××™×§×•×: "${location1}" ×¢×‘×•×¨ ${firstName1}`);
                        }
                    }
                    
                    // ×¢×™×‘×•×“ ×”××“× ×”×©× ×™
                    if (firstName2 && location2) {
                        const parsed2 = parseLocation(location2);
                        if (parsed2) {
                            const seatId = `${parsed2.row}-${parsed2.seat}`;
                            if (seatsData[seatId]) {
                                // ×©× ××œ× = ×©× ×¤×¨×˜×™ + ×©× ××©×¤×—×”
                                const fullName2 = familyName ? 
                                    `${String(firstName2).trim()} ${familyName}` : 
                                    String(firstName2).trim();
                                
                                seatsData[seatId].occupied = true;
                                seatsData[seatId].person = {
                                    name: fullName2,
                                    gender: String(gender2 || '').trim(),
                                    notes: '××§×•×‘×¥ ×”××§×¡×œ'
                                };
                                processedPeople++;
                                debugInfo.push(`âœ“ ××“× 2: ${fullName2} ×‘××§×•× ${seatId}`);
                            } else {
                                debugInfo.push(`âœ— ××§×•× ×œ× ×§×™×™×: ${seatId} ×¢×‘×•×¨ ${firstName2}`);
                            }
                        } else {
                            debugInfo.push(`âœ— ×œ× × ×™×ª×Ÿ ×œ×¤×¢× ×— ××™×§×•×: "${location2}" ×¢×‘×•×¨ ${firstName2}`);
                        }
                    }
                }
                
                // ×¢×“×›×•×Ÿ ××™×“×¢ ×“×™×‘×•×’
                document.getElementById('debugContent').innerHTML = debugInfo.join('<br>');
                
                // ×©××•×¨ × ×ª×•× ×™× ××§×•×¨×™×™×
                originalSeatsData = JSON.parse(JSON.stringify(seatsData));
                
                // ×˜×¢×Ÿ ×©×™× ×•×™×™× ××§×•××™×™× (×× ×™×©)
                const hasLocalChanges = loadFromLocalStorage();
                
                // ×¢×“×›×Ÿ ×ª×¦×•×’×”
                Object.keys(seatsData).forEach(seatId => {
                    updateSeatDisplay(seatId);
                });
                
                updateStats();
                
                const message = hasLocalChanges ? 
                    `× ×˜×¢× ×• ${processedPeople} ×× ×©×™× ××”×§×•×‘×¥ + ×”×©×™× ×•×™×™× ×”××§×•××™×™× ×©×œ×š!` : 
                    `× ×˜×¢× ×• ${processedPeople} ×× ×©×™× ×‘×”×¦×œ×—×” ××”×§×•×‘×¥!`;
                    
                console.log(message);
                alert(message);
                
            } catch (error) {
                console.error('Error loading Excel:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥: ' + error.message);
            }
        }

        function saveToLocal() {
            saveToLocalStorage();
            alert('×”×©×™× ×•×™×™× × ×©××¨×• ×‘××—×©×‘ ×©×œ×š!');
        }

        function resetToOriginal() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×—×–×•×¨ ×œ× ×ª×•× ×™× ×”××§×•×¨×™×™× ××”×§×•×‘×¥? ×›×œ ×”×©×™× ×•×™×™× ×©×œ×š ×™××‘×“×•!')) {
                // ××—×§ × ×ª×•× ×™× ××§×•××™×™×
                localStorage.removeItem('hallSeatsData');
                
                // ×—×–×•×¨ ×œ× ×ª×•× ×™× ××§×•×¨×™×™×
                if (originalSeatsData && Object.keys(originalSeatsData).length > 0) {
                    seatsData = JSON.parse(JSON.stringify(originalSeatsData));
                    
                    // ×¢×“×›×Ÿ ×ª×¦×•×’×”
                    Object.keys(seatsData).forEach(seatId => {
                        updateSeatDisplay(seatId);
                    });
                    
                    updateStats();
                    document.getElementById('searchResults').innerHTML = '';
                    alert('×—×–×¨×ª ×œ× ×ª×•× ×™× ×”××§×•×¨×™×™× ××”×§×•×‘×¥!');
                } else {
                    alert('××™×Ÿ × ×ª×•× ×™× ××§×•×¨×™×™×. × × ×œ×˜×¢×•×Ÿ ××”×§×•×‘×¥ ×ª×—×™×œ×”.');
                }
            }
        }

        function clearAllSeats() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ× ×§×•×ª ××ª ×›×œ ×”××§×•××•×ª? ×”×©×™× ×•×™×™× ×™×™×©××¨×• ××•×˜×•××˜×™×ª.')) {
                Object.keys(seatsData).forEach(seatId => {
                    seatsData[seatId].occupied = false;
                    seatsData[seatId].person = null;
                    updateSeatDisplay(seatId);
                });
                
                updateStats();
                saveToLocalStorage(); // ×©××™×¨×” ××•×˜×•××˜×™×ª
                document.getElementById('searchResults').innerHTML = '';
                alert('×›×œ ×”××§×•××•×ª × ×•×§×•!');
            }
        }

        function toggleDebug() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
        }

        // ×¡×’×™×¨×ª ××•×“×œ ×‘×œ×—×™×¦×” ××—×•×¥ ×œ×ª×•×›×Ÿ
        window.onclick = function(event) {
            const modal = document.getElementById('seatModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ×§×™×¦×•×¨×™ ××§×œ×“×ª
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
