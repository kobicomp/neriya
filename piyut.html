<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול מקומות ישיבה</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
            padding: 20px;
        }

        .sidebar {
            width: 350px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            height: fit-content;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .hall-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: auto;
            position: relative;
        }

        .search-section {
            margin-bottom: 25px;
        }

        .search-section h3 {
            margin-bottom: 15px;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .search-group {
            margin-bottom: 15px;
        }

        .search-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .search-group input,
        .search-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-group input:focus,
        .search-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .stats {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats h4 {
            margin-bottom: 10px;
            color: #1f2937;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .stat-label {
            color: #6b7280;
        }

        .stat-value {
            font-weight: 600;
            color: #1f2937;
        }

        .occupied { color: #dc2626; }
        .available { color: #059669; }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .hall-map {
            direction: ltr;
            position: relative;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            min-height: 600px;
            overflow: auto;
        }

        .bimah {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 80px;
            background: #8b5cf6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .seating-area {
            margin-top: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .row-label {
            width: 35px;
            height: 30px;
            background: #4f46e5;
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            margin-left: 15px;
        }

        .seat {
            width: 35px;
            height: 35px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            background: white;
            position: relative;
        }

        .seat:hover {
            transform: scale(1.1);
            z-index: 5;
        }

        .seat.available {
            background: #dcfce7;
            border-color: #16a34a;
            color: #15803d;
        }

        .seat.occupied {
            background: #fecaca;
            border-color: #dc2626;
            color: #b91c1c;
        }

        .seat.selected {
            background: #dbeafe;
            border-color: #2563eb;
            color: #1d4ed8;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
        }

        .seat-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 10;
            margin-bottom: 5px;
        }

        .seat:hover .seat-tooltip {
            opacity: 1;
        }

        .seat-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1f2937;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #1f2937;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-size: 0.85rem;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #1f2937;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #d1d5db;
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .hall-map {
                padding: 15px;
            }
            
            .seat {
                width: 30px;
                height: 30px;
                font-size: 0.7rem;
            }
            
            .modal-content {
                padding: 20px;
            }
        }

        .info-box {
            margin-top: 15px;
            padding: 10px;
            background: #e0f2fe;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .gender-indicator {
            font-size: 0.7rem;
            margin-right: 2px;
        }

        .male { color: #2563eb; }
        .female { color: #db2777; }

        .debug-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🪑 מערכת ניהול מקומות ישיבה</h1>
            <p>ניהול והקצאת מקומות באולם</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="search-section">
                    <h3>🔍 חיפוש ומיון</h3>
                    
                    <div class="search-group">
                        <label>חיפוש לפי שם</label>
                        <input type="text" id="searchName" placeholder="הכנס שם לחיפוש...">
                    </div>
                    
                    <div class="search-group">
                        <label>חיפוש לפי מקום</label>
                        <input type="text" id="searchSeat" placeholder="למשל: 5-7">
                    </div>
                    
                    <div class="search-group">
                        <label>מצב מקום</label>
                        <select id="filterStatus">
                            <option value="">הכל</option>
                            <option value="available">פנוי</option>
                            <option value="occupied">תפוס</option>
                        </select>
                    </div>

                    <div class="search-group">
                        <label>מגדר</label>
                        <select id="filterGender">
                            <option value="">הכל</option>
                            <option value="זכר">זכר</option>
                            <option value="נקבה">נקבה</option>
                        </select>
                    </div>
                </div>

                <div class="stats">
                    <h4>📊 סטטיסטיקות</h4>
                    <div class="stat-item">
                        <span class="stat-label">סה"כ מקומות:</span>
                        <span class="stat-value" id="totalSeats">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">מקומות תפוסים:</span>
                        <span class="stat-value occupied" id="occupiedSeats">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">מקומות פנויים:</span>
                        <span class="stat-value available" id="availableSeats">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">זכרים:</span>
                        <span class="stat-value male" id="maleCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">נקבות:</span>
                        <span class="stat-value female" id="femaleCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">תפוסה:</span>
                        <span class="stat-value" id="occupancyRate">0%</span>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="loadFromExcel()">📁 טען מהקובץ</button>
                    <button class="btn btn-primary" onclick="saveToLocal()">💾 שמור שינויים</button>
                    <button class="btn btn-secondary" onclick="resetToOriginal()">🔄 חזור למקור</button>
                    <button class="btn btn-secondary" onclick="toggleDebug()">🔧 דיבוג</button>
                    <button class="btn btn-danger" onclick="clearAllSeats()">🗑️ נקה הכל</button>
                </div>

                <div class="info-box">
                    <strong>💡 מבנה הקובץ:</strong><br>
                    • B: שם משפחה<br>
                    • D: שם פרטי 1 | E: מגדר | F: מקום<br>
                    • G: שם פרטי 2 | H: מגדר | I: מקום<br>
                    • פורמט: "שורה X כיסא Y"
                </div>

                <div id="debugInfo" class="debug-info" style="display: none;">
                    <strong>🔧 מידע דיבוג:</strong>
                    <div id="debugContent"></div>
                </div>

                <div id="searchResults"></div>
            </div>

            <div class="hall-container">
                <div class="legend">
                    <h4>מקרא</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dcfce7; border-color: #16a34a;"></div>
                        <span>פנוי</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fecaca; border-color: #dc2626;"></div>
                        <span>תפוס</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dbeafe; border-color: #2563eb;"></div>
                        <span>נבחר</span>
                    </div>
                    <div class="legend-item">
                        <span style="color: #2563eb;">♂</span>
                        <span>זכר</span>
                    </div>
                    <div class="legend-item">
                        <span style="color: #db2777;">♀</span>
                        <span>נקבה</span>
                    </div>
                </div>

                <div class="hall-map">
                    <div class="bimah">בימה</div>
                    <div class="seating-area" id="seatingArea">
                        <!-- המקומות יווצרו כאן דינמית -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for seat assignment -->
    <div id="seatModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">הקצאת מקום</h3>
            <div class="form-group">
                <label>מספר מקום</label>
                <input type="text" id="seatNumber" readonly>
            </div>
            <div class="form-group">
                <label>שם מלא</label>
                <input type="text" id="personName" placeholder="הכנס שם מלא">
            </div>
            <div class="form-group">
                <label>מגדר</label>
                <select id="personGender">
                    <option value="">בחר מגדר</option>
                    <option value="זכר">זכר</option>
                    <option value="נקבה">נקבה</option>
                </select>
            </div>
            <div class="form-group">
                <label>הערות (אופציונלי)</label>
                <input type="text" id="personNotes" placeholder="הערות נוספות">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">ביטול</button>
                <button class="btn btn-danger" id="removeBtn" onclick="removePerson()" style="display: none;">הסר</button>
                <button class="btn btn-primary" id="assignBtn" onclick="assignSeat()">הקצה</button>
            </div>
        </div>
    </div>

    <script>
        // נתוני המקומות
        let seatsData = {};
        let originalSeatsData = {}; // נתונים מקוריים מהאקסל
        let selectedSeatId = null;

        // הגדרות האולם - שורות במספרים
        const hallLayout = {
            rows: [
                { label: '1', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '2', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '3', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '4', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '5', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '6', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '7', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '8', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '9', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '10', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '11', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] },
                { label: '12', seats: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20] }
            ]
        };

        // אתחול המערכת
        window.addEventListener('load', function() {
            createSeatingLayout();
            loadFromExcel(); // טעינה אוטומטית
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('searchName').addEventListener('input', performSearch);
            document.getElementById('searchSeat').addEventListener('input', performSearch);
            document.getElementById('filterStatus').addEventListener('change', performSearch);
            document.getElementById('filterGender').addEventListener('change', performSearch);
        }

        // פונקציה לפירוש "שורה X כיסא Y"
        function parseLocation(locationStr) {
            if (!locationStr || typeof locationStr !== 'string') return null;
            
            const match = locationStr.match(/שורה\s*(\d+)\s*כיסא\s*(\d+)/);
            if (match) {
                return {
                    row: parseInt(match[1]),
                    seat: parseInt(match[2])
                };
            }
            return null;
        }

        // שמירה אוטומטית ב-localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('hallSeatsData', JSON.stringify(seatsData));
                console.log('נתונים נשמרו מקומית');
            } catch (error) {
                console.error('שגיאה בשמירה מקומית:', error);
            }
        }

        // טעינה מ-localStorage
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('hallSeatsData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // מיזוג עם הנתונים הקיימים
                    Object.keys(parsedData).forEach(seatId => {
                        if (seatsData[seatId]) {
                            seatsData[seatId] = { ...seatsData[seatId], ...parsedData[seatId] };
                        }
                    });
                    console.log('נתונים נטענו מהשמירה המקומית');
                    return true;
                }
            } catch (error) {
                console.error('שגיאה בטעינה מקומית:', error);
            }
            return false;
        }

        function createSeatingLayout() {
            const seatingArea = document.getElementById('seatingArea');
            seatingArea.innerHTML = '';

            hallLayout.rows.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';

                // תווית השורה
                const rowLabel = document.createElement('div');
                rowLabel.className = 'row-label';
                rowLabel.textContent = row.label;
                rowDiv.appendChild(rowLabel);

                // יצירת כסאות
                row.seats.forEach(seatNum => {
                    const seatId = `${row.label}-${seatNum}`;
                    const seat = document.createElement('div');
                    seat.className = 'seat available';
                    seat.id = seatId;
                    seat.textContent = seatNum;
                    seat.onclick = () => selectSeat(seatId);

                    // tooltip
                    const tooltip = document.createElement('div');
                    tooltip.className = 'seat-tooltip';
                    tooltip.textContent = `מקום ${seatId} - פנוי`;
                    seat.appendChild(tooltip);

                    rowDiv.appendChild(seat);

                    // אתחול נתוני המקום
                    seatsData[seatId] = {
                        id: seatId,
                        row: row.label,
                        number: seatNum,
                        occupied: false,
                        person: null
                    };
                });

                seatingArea.appendChild(rowDiv);
            });
        }

        function selectSeat(seatId) {
            // ביטול בחירה קודמת
            if (selectedSeatId) {
                document.getElementById(selectedSeatId).classList.remove('selected');
            }

            selectedSeatId = seatId;
            document.getElementById(seatId).classList.add('selected');
            
            openModal(seatId);
        }

        function openModal(seatId) {
            const seat = seatsData[seatId];
            const modal = document.getElementById('seatModal');
            
            document.getElementById('seatNumber').value = seatId;
            
            if (seat.occupied) {
                // מקום תפוס - מצב עריכה
                document.getElementById('modalTitle').textContent = `עריכת מקום ${seatId}`;
                document.getElementById('personName').value = seat.person.name;
                document.getElementById('personGender').value = seat.person.gender || '';
                document.getElementById('personNotes').value = seat.person.notes || '';
                document.getElementById('removeBtn').style.display = 'inline-block';
                document.getElementById('assignBtn').textContent = 'עדכן';
            } else {
                // מקום פנוי - מצב הקצאה חדשה
                document.getElementById('modalTitle').textContent = `הקצאת מקום ${seatId}`;
                document.getElementById('personName').value = '';
                document.getElementById('personGender').value = '';
                document.getElementById('personNotes').value = '';
                document.getElementById('removeBtn').style.display = 'none';
                document.getElementById('assignBtn').textContent = 'הקצה';
            }
            
            modal.style.display = 'block';
            document.getElementById('personName').focus();
        }

        function closeModal() {
            document.getElementById('seatModal').style.display = 'none';
            
            // ביטול בחירה
            if (selectedSeatId) {
                document.getElementById(selectedSeatId).classList.remove('selected');
                selectedSeatId = null;
            }
        }

        function assignSeat() {
            const seatId = document.getElementById('seatNumber').value;
            const name = document.getElementById('personName').value.trim();
            const gender = document.getElementById('personGender').value;
            
            if (!name) {
                alert('נא להכניס שם');
                return;
            }
            
            const notes = document.getElementById('personNotes').value.trim();
            
            // עדכון נתוני המקום
            seatsData[seatId].occupied = true;
            seatsData[seatId].person = {
                name: name,
                gender: gender,
                notes: notes
            };
            
            updateSeatDisplay(seatId);
            updateStats();
            saveToLocalStorage(); // שמירה אוטומטית
            closeModal();
        }

        function removePerson() {
            if (!selectedSeatId) return;
            
            if (confirm('האם אתה בטוח שברצונך להסיר את האדם ממקום זה?')) {
                seatsData[selectedSeatId].occupied = false;
                seatsData[selectedSeatId].person = null;
                
                updateSeatDisplay(selectedSeatId);
                updateStats();
                saveToLocalStorage(); // שמירה אוטומטית
                closeModal();
            }
        }

        function updateSeatDisplay(seatId) {
            const seatElement = document.getElementById(seatId);
            const seat = seatsData[seatId];
            const tooltip = seatElement.querySelector('.seat-tooltip');
            
            if (seat.occupied) {
                seatElement.className = 'seat occupied';
                const genderIcon = seat.person.gender === 'זכר' ? '♂' : seat.person.gender === 'נקבה' ? '♀' : '';
                const genderClass = seat.person.gender === 'זכר' ? 'male' : seat.person.gender === 'נקבה' ? 'female' : '';
                
                // הוספת אייקון מגדר לכסא
                seatElement.innerHTML = `
                    <span class="gender-indicator ${genderClass}">${genderIcon}</span>
                    ${seat.number}
                `;
                
                tooltip.textContent = `מקום ${seatId} - ${seat.person.name} (${seat.person.gender || 'לא צוין'})`;
            } else {
                seatElement.className = 'seat available';
                seatElement.innerHTML = seat.number;
                tooltip.textContent = `מקום ${seatId} - פנוי`;
            }
        }

        function updateStats() {
            const totalSeats = Object.keys(seatsData).length;
            const occupiedSeats = Object.values(seatsData).filter(seat => seat.occupied).length;
            const availableSeats = totalSeats - occupiedSeats;
            const occupancyRate = totalSeats > 0 ? Math.round((occupiedSeats / totalSeats) * 100) : 0;
            
            const maleCount = Object.values(seatsData).filter(seat => 
                seat.occupied && seat.person && seat.person.gender === 'זכר').length;
            const femaleCount = Object.values(seatsData).filter(seat => 
                seat.occupied && seat.person && seat.person.gender === 'נקבה').length;
            
            document.getElementById('totalSeats').textContent = totalSeats;
            document.getElementById('occupiedSeats').textContent = occupiedSeats;
            document.getElementById('availableSeats').textContent = availableSeats;
            document.getElementById('occupancyRate').textContent = occupancyRate + '%';
            document.getElementById('maleCount').textContent = maleCount;
            document.getElementById('femaleCount').textContent = femaleCount;
        }

        function performSearch() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const searchSeat = document.getElementById('searchSeat').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value;
            const filterGender = document.getElementById('filterGender').value;
            
            const results = Object.values(seatsData).filter(seat => {
                const matchName = !searchName || (seat.person && seat.person.name.toLowerCase().includes(searchName));
                const matchSeat = !searchSeat || seat.id.toLowerCase().includes(searchSeat);
                const matchStatus = !filterStatus || 
                    (filterStatus === 'occupied' && seat.occupied) ||
                    (filterStatus === 'available' && !seat.occupied);
                const matchGender = !filterGender || (seat.person && seat.person.gender === filterGender);
                
                return matchName && matchSeat && matchStatus && matchGender;
            });
            
            displaySearchResults(results);
            highlightSeats(results);
        }

        function displaySearchResults(results) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            let html = '<div style="margin-top: 20px;"><h4>🔍 תוצאות חיפוש:</h4>';
            
            results.forEach(seat => {
                const status = seat.occupied ? 'תפוס' : 'פנוי';
                const personInfo = seat.person ? ` - ${seat.person.name}` : '';
                const genderInfo = seat.person && seat.person.gender ? ` (${seat.person.gender})` : '';
                const statusClass = seat.occupied ? 'occupied' : 'available';
                
                html += `
                    <div style="padding: 8px; margin: 5px 0; border-radius: 4px; background: white; border: 1px solid #e5e7eb; cursor: pointer;" 
                         onclick="selectSeat('${seat.id}')">
                        <strong>${seat.id}</strong> 
                        <span class="${statusClass}">(${status})</span>
                        ${personInfo}${genderInfo}
                    </div>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function highlightSeats(results) {
            // איפוס הדגשות קודמות
            Object.keys(seatsData).forEach(seatId => {
                const element = document.getElementById(seatId);
                element.style.boxShadow = '';
                element.style.transform = '';
            });
            
            // הדגשת תוצאות החיפוש
            results.forEach(seat => {
                const element = document.getElementById(seat.id);
                element.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.5)';
                element.style.transform = 'scale(1.05)';
            });
        }

        async function loadFromExcel() {
            try {
                console.log('טוען נתונים מהקובץ...');
                
                const response = await fetch('1.xlsx');
                if (!response.ok) {
                    throw new Error('לא ניתן לטעון את הקובץ');
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // נסה את הגליון הראשון אם 'a' לא קיים
                const sheetName = workbook.SheetNames.includes('a') ? 'a' : workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                
                // קריאה כמערך גולמי (ללא כותרות)
                const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                console.log('נתונים גולמיים:', rawData.slice(0, 5));
                
                // אתחול כל המקומות כפנויים
                Object.keys(seatsData).forEach(seatId => {
                    seatsData[seatId].occupied = false;
                    seatsData[seatId].person = null;
                });
                
                let processedPeople = 0;
                let debugInfo = [];
                
                // עיבוד הנתונים מהשורה השנייה ואילך
                for (let i = 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    if (!row || row.length === 0) continue;
                    
                    debugInfo.push(`שורה ${i+1}: ${JSON.stringify(row.slice(1, 9))}`);
                    
                    // עמודה B - שם משפחה (אינדקס 1)
                    const familyName = row[1] ? String(row[1]).trim() : '';
                    
                    // אדם ראשון - עמודות D,E,F (אינדקס 3,4,5)
                    const firstName1 = row[3];     // עמודה D - שם פרטי
                    const gender1 = row[4];        // עמודה E - מגדר
                    const location1 = row[5];      // עמודה F - מקום
                    
                    // אדם שני - עמודות G,H,I (אינדקס 6,7,8)
                    const firstName2 = row[6];     // עמודה G - שם פרטי
                    const gender2 = row[7];        // עמודה H - מגדר
                    const location2 = row[8];      // עמודה I - מקום
                    
                    // עיבוד האדם הראשון
                    if (firstName1 && location1) {
                        const parsed1 = parseLocation(location1);
                        if (parsed1) {
                            const seatId = `${parsed1.row}-${parsed1.seat}`;
                            if (seatsData[seatId]) {
                                // שם מלא = שם פרטי + שם משפחה
                                const fullName1 = familyName ? 
                                    `${String(firstName1).trim()} ${familyName}` : 
                                    String(firstName1).trim();
                                
                                seatsData[seatId].occupied = true;
                                seatsData[seatId].person = {
                                    name: fullName1,
                                    gender: String(gender1 || '').trim(),
                                    notes: 'מקובץ האקסל'
                                };
                                processedPeople++;
                                debugInfo.push(`✓ אדם 1: ${fullName1} במקום ${seatId}`);
                            } else {
                                debugInfo.push(`✗ מקום לא קיים: ${seatId} עבור ${firstName1}`);
                            }
                        } else {
                            debugInfo.push(`✗ לא ניתן לפענח מיקום: "${location1}" עבור ${firstName1}`);
                        }
                    }
                    
                    // עיבוד האדם השני
                    if (firstName2 && location2) {
                        const parsed2 = parseLocation(location2);
                        if (parsed2) {
                            const seatId = `${parsed2.row}-${parsed2.seat}`;
                            if (seatsData[seatId]) {
                                // שם מלא = שם פרטי + שם משפחה
                                const fullName2 = familyName ? 
                                    `${String(firstName2).trim()} ${familyName}` : 
                                    String(firstName2).trim();
                                
                                seatsData[seatId].occupied = true;
                                seatsData[seatId].person = {
                                    name: fullName2,
                                    gender: String(gender2 || '').trim(),
                                    notes: 'מקובץ האקסל'
                                };
                                processedPeople++;
                                debugInfo.push(`✓ אדם 2: ${fullName2} במקום ${seatId}`);
                            } else {
                                debugInfo.push(`✗ מקום לא קיים: ${seatId} עבור ${firstName2}`);
                            }
                        } else {
                            debugInfo.push(`✗ לא ניתן לפענח מיקום: "${location2}" עבור ${firstName2}`);
                        }
                    }
                }
                
                // עדכון מידע דיבוג
                document.getElementById('debugContent').innerHTML = debugInfo.join('<br>');
                
                // שמור נתונים מקוריים
                originalSeatsData = JSON.parse(JSON.stringify(seatsData));
                
                // טען שינויים מקומיים (אם יש)
                const hasLocalChanges = loadFromLocalStorage();
                
                // עדכן תצוגה
                Object.keys(seatsData).forEach(seatId => {
                    updateSeatDisplay(seatId);
                });
                
                updateStats();
                
                const message = hasLocalChanges ? 
                    `נטענו ${processedPeople} אנשים מהקובץ + השינויים המקומיים שלך!` : 
                    `נטענו ${processedPeople} אנשים בהצלחה מהקובץ!`;
                    
                console.log(message);
                alert(message);
                
            } catch (error) {
                console.error('Error loading Excel:', error);
                alert('שגיאה בטעינת הקובץ: ' + error.message);
            }
        }

        function saveToLocal() {
            saveToLocalStorage();
            alert('השינויים נשמרו במחשב שלך!');
        }

        function resetToOriginal() {
            if (confirm('האם אתה בטוח שברצונך לחזור לנתונים המקוריים מהקובץ? כל השינויים שלך יאבדו!')) {
                // מחק נתונים מקומיים
                localStorage.removeItem('hallSeatsData');
                
                // חזור לנתונים מקוריים
                if (originalSeatsData && Object.keys(originalSeatsData).length > 0) {
                    seatsData = JSON.parse(JSON.stringify(originalSeatsData));
                    
                    // עדכן תצוגה
                    Object.keys(seatsData).forEach(seatId => {
                        updateSeatDisplay(seatId);
                    });
                    
                    updateStats();
                    document.getElementById('searchResults').innerHTML = '';
                    alert('חזרת לנתונים המקוריים מהקובץ!');
                } else {
                    alert('אין נתונים מקוריים. נא לטעון מהקובץ תחילה.');
                }
            }
        }

        function clearAllSeats() {
            if (confirm('האם אתה בטוח שברצונך לנקות את כל המקומות? השינויים יישמרו אוטומטית.')) {
                Object.keys(seatsData).forEach(seatId => {
                    seatsData[seatId].occupied = false;
                    seatsData[seatId].person = null;
                    updateSeatDisplay(seatId);
                });
                
                updateStats();
                saveToLocalStorage(); // שמירה אוטומטית
                document.getElementById('searchResults').innerHTML = '';
                alert('כל המקומות נוקו!');
            }
        }

        function toggleDebug() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
        }

        // סגירת מודל בלחיצה מחוץ לתוכן
        window.onclick = function(event) {
            const modal = document.getElementById('seatModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // קיצורי מקלדת
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
